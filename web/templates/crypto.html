{% extends "header.html" %} {% block content %}
<div class="container">
  <h2>File Encryption/Decryption Tool</h2>

  <div class="card mb-4">
    <div class="card-header">Key Management</div>
    <div class="card-body">
      <div class="form-group">
        <label for="keyInput">Encryption Key:</label>
        <input
          type="text"
          class="form-control"
          id="keyInput"
          placeholder="Enter your key or leave empty for random key"
        />
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="useRandomKey" />
        <label class="form-check-label" for="useRandomKey"
          >Generate Random Key</label
        >
      </div>
      <button id="copyKeyBtn" class="btn btn-secondary">
        Copy Key to Clipboard
      </button>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">Encrypt File</div>
        <div class="card-body">
          <form id="encryptForm" enctype="multipart/form-data">
            <div class="form-group">
              <label for="encryptFile">Select file to encrypt:</label>
              <input
                type="file"
                class="form-control-file"
                id="encryptFile"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">Encrypt File</button>
          </form>
          <div id="encryptProgress" class="mt-3" style="display: none">
            <div class="progress">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
            <p class="text-center mt-2">Processing...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">Decrypt File</div>
        <div class="card-body">
          <form id="decryptForm" enctype="multipart/form-data">
            <div class="form-group">
              <label for="decryptFile">Select file to decrypt:</label>
              <input
                type="file"
                class="form-control-file"
                id="decryptFile"
                required
              />
            </div>
            <button type="submit" class="btn btn-success">Decrypt File</button>
          </form>
          <div id="decryptProgress" class="mt-3" style="display: none">
            <div class="progress">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
            <p class="text-center mt-2">Processing...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="resultAlert" class="alert mt-4" style="display: none"></div>
</div>

<script>
  $(document).ready(function () {
    // Generate random key when checkbox is clicked
    $("#useRandomKey").change(function () {
      if (this.checked) {
        fetch("/random_key")
          .then((response) => response.json())
          .then((data) => {
            $("#keyInput").val(data.key);
          });
      }
    });

    // Copy key to clipboard
    $("#copyKeyBtn").click(function () {
      const keyInput = $("#keyInput");
      keyInput.select();
      document.execCommand("copy");
      alert("Key copied to clipboard!");
    });

    // Encrypt form submission
    $("#encryptForm").submit(function (e) {
      e.preventDefault();
      const formData = new FormData();
      formData.append("file", $("#encryptFile")[0].files[0]);
      formData.append("key", $("#keyInput").val());
      formData.append("use_random_key", $("#useRandomKey").is(":checked"));

      $("#encryptProgress").show();
      $("#encryptForm button").prop("disabled", true);

      fetch("/encrypt", {
        method: "POST",
        body: formData,
      })
        .then((response) => {
          if (response.ok) {
            return response.blob();
          }
          return response.json().then((err) => {
            throw err;
          });
        })
        .then((blob) => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = $("#encryptFile")[0].files[0].name + "_ENCRYPTED";
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);

          $("#resultAlert")
            .removeClass("alert-danger")
            .addClass("alert-success")
            .text("File encrypted successfully!")
            .show();
        })
        .catch((error) => {
          $("#resultAlert")
            .removeClass("alert-success")
            .addClass("alert-danger")
            .text(error.error || "Encryption failed")
            .show();
        })
        .finally(() => {
          $("#encryptProgress").hide();
          $("#encryptForm button").prop("disabled", false);
        });
    });

    // Decrypt form submission
    $("#decryptForm").submit(function (e) {
      e.preventDefault();
      const formData = new FormData();
      formData.append("file", $("#decryptFile")[0].files[0]);
      formData.append("key", $("#keyInput").val());

      $("#decryptProgress").show();
      $("#decryptForm button").prop("disabled", true);

      fetch("/decrypt", {
        method: "POST",
        body: formData,
      })
        .then((response) => {
          if (response.ok) {
            return response.blob();
          }
          return response.json().then((err) => {
            throw err;
          });
        })
        .then((blob) => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = $("#decryptFile")[0].files[0].name.replace(
            "_ENCRYPTED",
            "_DECRYPTED"
          );
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);

          $("#resultAlert")
            .removeClass("alert-danger")
            .addClass("alert-success")
            .text("File decrypted successfully!")
            .show();
        })
        .catch((error) => {
          $("#resultAlert")
            .removeClass("alert-success")
            .addClass("alert-danger")
            .text(error.error || "Decryption failed")
            .show();
        })
        .finally(() => {
          $("#decryptProgress").hide();
          $("#decryptForm button").prop("disabled", false);
        });
    });
  });
</script>

<style>
  .card {
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  .card-header {
    font-weight: bold;
  }
  .progress {
    height: 20px;
  }
</style>
{% endblock %}
